pipeline {
    agent any

    environment {
        // Core Playwright Environment
        PLAYWRIGHT_REPORT_DIR = "playwright-report"
        NODE_ENV = "stage"

        // Non-sensitive URLs and config
        INTERNAL_URL = "https://internal.st.openscreen.com"
        DASHBOARD_URL = "https://app.st.openscreen.com"
        OSPRO_URL = "https://st.ospro.co"
        APP_URL = "https://internal.st.track.openscreen.com"
        APP_ORIGIN = "https://app.st.openscreen.com"
        ACCOUNT_ID = "JR8167BH7500JJ"
        APP_ACCOUNT_ID = "AAKM9725CB5119HG"
        APP_ID = "e33d5f6b-ce73-4748-8b5a-5d8a99be5289"
        PHONE_NUMBER = "+14167228393"
        EMAIL = "test_38+playwright@openscreen.com"
        PASSWORD = "Qwerty12!"
        CUSTOM_DOMAIN = "playwright.test-openscreen.com"
        MICROSITE_DOMAIN = "playwrightmicrosite.test-openscreen.com"

        // Slack Channel for Notifications
        // SLACK_CHANNEL = '#automation-reports'
    }

    options {
        timestamps()
        disableConcurrentBuilds()
    }

    stages {

        stage('Install Dependencies') {
            steps {
                echo "üì¶ Installing dependencies..."
                sh 'npm ci'
                sh 'npx playwright install chromium'
            }
        }

        stage('Run Playwright Tests') {
            steps {
                echo "üöÄ Running Playwright tests..."
                script {
                    withCredentials([string(credentialsId: 'OP_SERVICE_ACCOUNT_TOKEN', variable: 'OP_SERVICE_ACCOUNT_TOKEN')]) {
                        try {
                            env.APP_BEARER_TOKEN = OP_SERVICE_ACCOUNT_TOKEN
                            echo "[DEBUG] About to run Playwright tests"
                            sh 'npm run test:automation || { echo "[ERROR] Playwright tests failed with exit $?"; exit 1; }'
                            echo "[DEBUG] Playwright tests finished, about to generate Excel report"
                            sh 'if [ -f scripts/generateExcelReport.js ]; then node scripts/generateExcelReport.js || { echo "[ERROR] Excel report generation failed with exit $?"; exit 1; }; else echo "[WARN] Excel report script not found"; fi'
                            echo "‚úÖ Playwright tests and Excel report completed successfully"
                        } catch (err) {
                            echo "[CATCH] ${err.toString()}"
                            echo "‚ùå Playwright tests or Excel report failed ‚Äî Check reports for details"
                            error("Playwright tests or Excel report failed.")
                        }
                    }
                }
            }


                        post {
                            always {
                                echo "\ud83d\udcc1 Archiving Playwright reports..."
                                // Archive Excel reports
                                archiveArtifacts artifacts: "${PLAYWRIGHT_REPORT_DIR}/*.xlsx", allowEmptyArchive: true
                                // Archive HTML report if needed
                                archiveArtifacts artifacts: "${PLAYWRIGHT_REPORT_DIR}/**/*.html", allowEmptyArchive: true
                            }

                            success {
                                echo "\ud83c\udf89 Build succeeded! Excel report is archived in artifacts."
                            }

                            failure {
                                echo "\ud83d\udea8 Build failed. Check Excel and HTML reports for details."
                            }
                        }
        }
    }
}

